<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8" />
	<title>Goo-net 検索</title>
	<style>
		:root { --sidebar-width: 260px; --gap:6px; --muted:#6b7280; --accent:#2563eb; --accent-2:#1e40af; --bg:#f5f7fb; --card:#ffffff; --border:#d0d6df; }
		body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; display:flex; flex-direction:column; background:var(--bg); color:#0f172a; }
		header.page-header { width:100%; border-bottom:1px solid var(--border); padding:10px 16px; box-sizing:border-box; background: DODGERBLUE; }
		.header-row { display:flex; gap:var(--gap); align-items:center; }
		.header-col { display:flex; flex-direction:column; min-width:120px; }
		.header-col label { font-size:.8rem; color:rgba(255,255,255,0.9); margin-bottom:4px; }
		.header-col .control { margin-top:0; }
		/* header inputs/buttons contrast */
		header.page-header input, header.page-header select { background: rgba(255,255,255,0.95); color:#0b1220; border:1px solid rgba(15,23,42,0.08); }
		header.page-header .btn-primary { background:#003db5; border-color:#002a80; }
		header.page-header .btn-secondary { background:#fff; }
		main { display:flex; flex:1; }
		aside { width:var(--sidebar-width); background:transparent; border-right:1px solid var(--border); padding:12px; box-sizing:border-box; }
		main > section { flex:1; padding:18px; overflow:auto; }
		/* core styles adjusted */
		h1 { margin-top:0; font-size:1.1rem; color:#0b1220; }
		fieldset { border:1px solid var(--border); margin:0 0 12px; padding:8px 10px; background:var(--card); box-shadow:0 1px 2px rgba(16,24,40,0.03); }
		fieldset legend { font-size:.85rem; padding:0 4px; color:var(--muted); }
		label { display:block; font-size:.8rem; margin:2px 0; color:var(--muted); }
		select, input[type=text], input[type=number] { width:100%; box-sizing:border-box; padding:6px 8px; border:1px solid var(--border); border-radius:6px; background:transparent; }
		.actions { display:flex; gap:8px; margin-top:8px; }
		button, .btn-link { cursor:pointer; font-size:.85rem; padding:7px 12px; border-radius:8px; border:1px solid transparent; transition:all .12s ease; }
		.btn-primary { background:var(--accent); color:#fff; border-color:var(--accent-2); box-shadow:0 4px 10px rgba(37,99,235,0.08); }
		.btn-primary:hover { transform:translateY(-1px); box-shadow:0 6px 14px rgba(37,99,235,0.12); }
		.btn-secondary { background:#fff; border:1px solid var(--border); color:#111827; }
		table { border-collapse:separate; border-spacing:0; width:100%; font-size:.85rem; background:var(--card); border-radius:8px; overflow:hidden; box-shadow:0 6px 18px rgba(15,23,42,0.04); }
		th, td { border-bottom:1px solid var(--border); padding:8px 10px; text-align:left; vertical-align:top; }
		th { background:#f7f9fc; position:sticky; top:0; z-index:2; font-weight:600; color:#0b1220; }
		th.num, td.num { text-align:right; }
		tbody tr:hover { background:linear-gradient(90deg, #ffffff, #fbfeff); }
		.flash { padding:8px 12px; margin:8px 0; border-radius:8px; font-size:.85rem; }
		.flash.info { background:#eef6ff; color:#0f172a; }
		.flash.error { background:#fff2f2; color:#7f1d1d; }
		.summary-files { margin-top:12px; }
		.count { font-size:.85rem; margin:6px 0 12px; color:var(--muted); }
		.scroll-x { overflow-x:auto; border-radius:8px; }
		a { color:var(--accent); }
		/* dynamic filter cards */
		.filter-cards { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
		.card { background:var(--card); border:1px solid var(--border); padding:8px; min-width:140px; position:relative; border-radius:8px; box-shadow:0 2px 6px rgba(2,6,23,0.04); }
		.card .close { position:absolute; right:6px; top:6px; cursor:pointer; color:#9ca3af; font-weight:700; }
		/* compact header controls */
		.header-row > .header-col { margin-right:0; }
		/* responsive tweaks */
		@media (max-width:900px){
			header.page-header { padding:10px; }
			.header-row { flex-direction:column; gap:8px; }
			aside { display:none; }
		}
	</style>
</head>
<body>
	<header class="page-header">
		<form id="global-search-form" method="get" action="/">
			<div class="header-row">
				<div class="header-col" style="flex:0 0 auto;">
					<div class="control">
						<input id="global-q" name="q" type="text" placeholder="全カラムを検索" value="{{ request.args.get('q','') }}" style="width:256px;" />
					</div>
				</div>
				<div class="header-col" style="width:100px;">
					<label style="visibility:hidden">検索ボタン</label>
					<div class="control">
						<button type="submit" class="btn-primary">検索</button>
					</div>
				</div>
				<div class="header-col" style="width:40px;">
					<label style="visibility:hidden">追加</label>
					<div class="control">
						<button id="add-filter" type="button" class="btn-secondary">+</button>
					</div>
				</div>
				<div class="header-col" style="flex:1 1 auto;">
					<div class="filter-cards" id="filter-cards" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
						<!-- dynamic filter cards will be inserted here -->
					</div>
				</div>
			</div>
		</form>
	</header>
	<main>
		<aside>
			<h1>検索条件</h1>
			<!-- Keep the old quick filters, but these will now serve as presets for adding cards -->
			<fieldset>
				<legend>プリセット(クリックでカード追加)</legend>
				<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
					<button type="button" class="btn-secondary" data-col="manufacturer">メーカー</button>
					<button type="button" class="btn-secondary" data-col="name">車名</button>
					<button type="button" class="btn-secondary" data-col="year">年式</button>
					<button type="button" class="btn-secondary" data-col="price">価格</button>
					<button type="button" class="btn-secondary" data-col="category">区分</button>
					<button type="button" class="btn-secondary" data-col="wd">駆動</button>
					<button type="button" class="btn-secondary" data-col="seat">席数</button>
					<button type="button" class="btn-secondary" data-col="door">ドア</button>
				</div>
			</fieldset>
			<div class="summary-files">
				<h2 style="font-size:1rem;">Summary Files</h2>
				{% if files %}
					<ul style="padding-left:16px; margin:4px 0; max-height:180px; overflow:auto;">
					{% for f in files %}
						<li style="font-size:.7rem;">
							<a href="{{ url_for('main.show_file', name=f) }}">{{ f }}</a>
						</li>
					{% endfor %}
					</ul>
				{% else %}<p style="font-size:.7rem;">なし</p>{% endif %}
			</div>
		</aside>
		<section>
			<div style="display:flex; justify-content:space-between; align-items:center;">
				<h1>検索結果</h1>
				<a href="/pivot" class="btn-link btn-secondary" style="margin-left:auto;">pivot</a>
			</div>
			{% with messages = get_flashed_messages(with_categories=true) %}
				{% if messages %}
					{% for cat, msg in messages %}<div class="flash {{ cat }}">{{ msg }}</div>{% endfor %}
				{% endif %}
			{% endwith %}
			<div class="count">{{ rows|length }} 件 (最大300件表示)</div>
			<div class="scroll-x">
				<table>
					<thead>
						<tr>
							<th data-col="url" class="no-sort">リンク</th>
							<th data-col="price" class="sortable num">価格(万)</th>
							<th data-col="year" class="sortable num">年式</th>
							<th data-col="manufacturer" class="sortable">メーカー</th>
							<th data-col="name" class="sortable">車名</th>
							<th data-col="rd" class="sortable num">走行距離</th>
							<th data-col="engine" class="sortable num">排気量</th>
							<th data-col="mission1" class="sortable">ミッション種別</th>
							<th data-col="mission2" class="sortable">ミッション詳細</th>
							<th data-col="bodytype" class="sortable">ボディ</th>
							<th data-col="category" class="sortable">区分</th>
							<th data-col="wd" class="sortable">駆動</th>
							<th data-col="seat" class="sortable">席数</th>
							<th data-col="door" class="sortable">ドア</th>
							<th data-col="fuel" class="sortable">燃料</th>
							<th data-col="handle" class="sortable">ハンドル</th>
							<th data-col="jc08" class="sortable">JC08</th>
							<th data-col="location" class="sortable">所在地</th>
							<th data-col="repair" class="sortable">修復</th>
						</tr>
					</thead>
					<tbody>
					{% for r in rows %}
						<tr{% if loop.index0 % 2 == 1 %} style="background:#e3f0fb;"{% endif %}>
							<td>{% if r.url %}<a href="{{ r.url }}" target="_blank" rel="noopener">open</a>{% endif %}</td>
							<td class="num">{% if r.price is not none %}{{ '{:,}'.format(r.price) }}万{% endif %}</td>
							<td class="num">{% if r.year is not none %}{{ r.year }}年式{% endif %}</td>
							<td>{{ r.manufacturer or '' }}</td>
							<td>{{ r.name or '' }}</td>
							<td class="num">{% if r.rd is not none %}{{ '{:,}'.format(r.rd) }}km{% endif %}</td>
							<td class="num">{% if r.engine is not none %}{{ '{:,}'.format(r.engine) }}cc{% endif %}</td>
							<td>{{ r.mission1 or '' }}</td>
							<td>{{ r.mission2 or '' }}</td>
							<td>{% if r.bodytype and r.bodytype != 'ボディタイプ' %}{{ r.bodytype }}{% endif %}</td>
							<td>{{ r.category or '' }}</td>
							<td>{{ r.wd or '' }}</td>
							<td>{{ r.seat or '' }}</td>
							<td>{{ r.door or '' }}</td>
							<td>{{ r.fuel or '' }}</td>
							<td>{{ r.handle or '' }}</td>
							<td>{{ r.jc08 or '' }}</td>
							<td>{{ r.location or '' }}</td>
							<td>{{ r.repair or '' }}</td>
						</tr>
					{% endfor %}
					{% if rows|length == 0 %}
						<tr><td colspan="10" style="text-align:center;color:#777;">該当なし</td></tr>
					{% endif %}
					</tbody>
				</table>
			</div>
			<script>
			(function(){
			  const params = new URLSearchParams(window.location.search);
			  const currentSort = params.get('sort') || '{{ sort }}';
			  const currentDir = params.get('dir') || '{{ dir }}';
			  document.querySelectorAll('th.sortable').forEach(th => {
			    const col = th.getAttribute('data-col');
			    if(col === currentSort){
			      th.style.background = '#dde7f5';
			      const arrow = currentDir === 'asc' ? '▲' : '▼';
			      th.innerHTML = th.textContent + ' ' + arrow;
			    }
			    th.addEventListener('click', () => {
			      let dir = 'asc';
			      if(col === currentSort){ dir = currentDir === 'asc' ? 'desc' : 'asc'; }
			      params.set('sort', col); params.set('dir', dir);
			      window.location.search = params.toString();
			    });
			  });

			  // Auto submit filters
			  const form = document.querySelector('aside form[action="/"]');
			  if(form){
			    const debounce = (fn, ms) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
			    const submit = ()=>{ form.submit(); };
			    const dsubmit = debounce(submit, 350);
			    form.querySelectorAll('select').forEach(el => { el.addEventListener('change', submit); });
				form.querySelectorAll('input[type=number]').forEach(el => { el.addEventListener('input', dsubmit); });
			  }

			  // header behavior: focus and Enter submits
			  const gq = document.getElementById('global-q');
			  if(gq){ gq.focus(); gq.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); document.getElementById('global-search-form').submit(); } }); }

			  // dynamic filter cards
			  const cardArea = document.getElementById('filter-cards');
			  const addBtn = document.getElementById('add-filter');
			  const presets = document.querySelectorAll('button[data-col]');
			  // Build option lists from server-provided variables
			  const OPTIONS = {
			    manufacturer: {{ manufacturers|tojson }},
			    name: {{ names|tojson }},
			    mission1: {{ mission1s|tojson }},
			    mission2: {{ mission2s|tojson }},
			    bodytype: {{ bodytypes|tojson }},
			    repair: {{ repairs|tojson }},
			    location: {{ locations|tojson }},
			    year: {{ years|tojson }},
			    category: {{ categories|tojson }},
			    wd: {{ wds|tojson }},
			    seat: {{ seats|tojson }},
			    door: {{ doors|tojson }},
			    fuel: {{ fuels|tojson }},
			    handle: {{ handles|tojson }},
			  };
			  const LABELS = {
			    manufacturer: 'メーカー', name: '車名', mission1: 'ミッション種別', mission2: 'ミッション詳細', bodytype: 'ボディ', repair: '修復歴', location: '所在地', year: '年式', category: '区分', wd: '駆動', seat: '席数', door: 'ドア', fuel: '燃料', handle: 'ハンドル', jc08: 'JC08', price: '価格'
			  };
			  function makeControlFor(col, value){
			    // If we have options for this column, build a select
			    if(col === 'price'){
			      const wrap = document.createElement('div');
			      const min = document.createElement('input'); min.type='number'; min.name='price_min'; min.placeholder='最小'; if(value && value.min) min.value=value.min;
			      const max = document.createElement('input'); max.type='number'; max.name='price_max'; max.placeholder='最大'; if(value && value.max) max.value=value.max;
			      min.style.width='80px'; max.style.width='80px'; min.style.marginRight='6px';
			      wrap.appendChild(min); wrap.appendChild(max);
			      return wrap;
			    }
			    const opts = OPTIONS[col];
			    if(opts && opts.length){
			      const sel = document.createElement('select'); sel.name = col;
			      const any = document.createElement('option'); any.value=''; any.textContent='(any)'; sel.appendChild(any);
			      opts.forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; if(value==o) opt.selected=true; sel.appendChild(opt); });
			      return sel;
			    }
			    // default: text input
			    const inp = document.createElement('input'); inp.type='text'; inp.name = col; inp.value = value || '';
			    return inp;
			  }
			  function makeCard(col, value){
			    const card = document.createElement('div'); card.className='card'; card.style.display='flex'; card.style.flexDirection='column'; card.style.minWidth='160px';
			    const close = document.createElement('span'); close.className='close'; close.textContent='×'; close.onclick = ()=>card.remove();
			    const top = document.createElement('div'); top.style.display='flex'; top.style.gap='6px'; top.style.alignItems='center';
			    const fld = document.createElement('select'); fld.style.flex='1';
			    // populate field select with LABELS
			    Object.keys(LABELS).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=LABELS[k]; if(k===col) o.selected=true; fld.appendChild(o); });
			    const control = makeControlFor(col, value);
			    fld.addEventListener('change', ()=>{
			      const newCol = fld.value;
			      const newControl = makeControlFor(newCol);
			      // replace control
			      if(control.parentNode) control.parentNode.replaceChild(newControl, control);
			    });
			    top.appendChild(fld);
			    top.appendChild(close);
			    card.appendChild(top);
			    card.appendChild(control);
			    return card;
			  }
			  addBtn.addEventListener('click', ()=>{
			    // temporary modal-less select insertion
			    const sel = document.createElement('select'); ['manufacturer','name','year','price','category','wd','seat','door','fuel','handle','jc08','mission1','mission2','bodytype','repair','location'].forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=LABELS[c]||c; sel.appendChild(o); });
			    const ok = document.createElement('button'); ok.textContent='OK'; ok.type='button'; ok.className='btn-secondary';
			    const wrapper = document.createElement('div'); wrapper.className='card'; wrapper.style.display='flex'; wrapper.style.flexDirection='row'; wrapper.style.alignItems='center'; wrapper.style.gap='6px'; wrapper.appendChild(sel); wrapper.appendChild(ok);
			    cardArea.appendChild(wrapper);
			    ok.addEventListener('click', ()=>{ const col = sel.value; wrapper.remove(); cardArea.appendChild(makeCard(col)); });
			  });
			  presets.forEach(b=> b.addEventListener('click', ()=>{ cardArea.appendChild(makeCard(b.getAttribute('data-col'))); }));
			})();
			</script>
		</section>
	</main>
</body>
</html>
