<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8" />
	<title>Goo-net 検索</title>
	<style>
		:root { --sidebar-width: 260px; --gap:6px; --muted:#6b7280; --accent:#2563eb; --accent-2:#1e40af; --bg:#f5f7fb; --card:#ffffff; --border:#d0d6df; }
		body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; display:flex; flex-direction:column; background:var(--bg); color:#0f172a; }
		header.page-header { width:100%; border-bottom:1px solid var(--border); padding:10px 16px; box-sizing:border-box; background: DODGERBLUE; }
	/* header converted to grid: first column flexible, remaining fixed 92px (now 11 controls) */
	.header-grid { display:grid; grid-template-columns: 1fr repeat(11, 92px); grid-auto-rows: auto; gap:var(--gap); align-items:center; }
		.header-label { color: rgba(255,255,255,0.95); background:transparent; font-size:.9rem; }
		.header-control { display:flex; justify-content:flex-start; }
		/* ensure controls are left-aligned and stacked to the left */
		.header-control > * { margin:0; }
		/* unified control width for header controls */
		.hdr-ctrl { width:92px; box-sizing:border-box; display:inline-block; margin-right:6px; }
		.header-col label { font-size:.8rem; color:rgba(255,255,255,0.9); margin-bottom:4px; }
		.header-col .control { margin-top:0; display:flex; align-items:center; }
		/* header inputs/buttons contrast */
		header.page-header input, header.page-header select { background: rgba(255,255,255,0.95); color:#0b1220; border:1px solid rgba(15,23,42,0.08); }
		header.page-header .btn-primary { background:#003db5; border-color:#002a80; }
		header.page-header .btn-secondary { background:#fff; }
		main { display:flex; flex:1; }
		aside { width:var(--sidebar-width); background:transparent; border-right:1px solid var(--border); padding:12px; box-sizing:border-box; }
		main > section { flex:1; padding:18px; overflow:auto; }
		/* core styles adjusted */
		h1 { margin-top:0; font-size:1.1rem; color:#0b1220; }
		fieldset { border:1px solid var(--border); margin:0 0 12px; padding:8px 10px; background:var(--card); box-shadow:0 1px 2px rgba(16,24,40,0.03); }
		fieldset legend { font-size:.85rem; padding:0 4px; color:var(--muted); }
		label { display:block; font-size:.8rem; margin:2px 0; color:var(--muted); }
		select, input[type=text], input[type=number] { width:100%; box-sizing:border-box; padding:6px 8px; border:1px solid var(--border); border-radius:6px; background:transparent; }
		.actions { display:flex; gap:8px; margin-top:8px; }
		button, .btn-link { cursor:pointer; font-size:.85rem; padding:7px 12px; border-radius:8px; border:1px solid transparent; transition:all .12s ease; }
		.btn-primary { background:var(--accent); color:#fff; border-color:var(--accent-2); box-shadow:0 4px 10px rgba(37,99,235,0.08); }
		.btn-primary:hover { transform:translateY(-1px); box-shadow:0 6px 14px rgba(37,99,235,0.12); }
		.btn-secondary { background:#fff; border:1px solid var(--border); color:#111827; }
		table { border-collapse:separate; border-spacing:0; width:100%; font-size:.85rem; background:var(--card); border-radius:8px; overflow:hidden; box-shadow:0 6px 18px rgba(15,23,42,0.04); }
		th, td { border-bottom:1px solid var(--border); padding:8px 10px; text-align:left; vertical-align:top; }
		th { background:#f7f9fc; position:sticky; top:0; z-index:2; font-weight:600; color:#0b1220; }
		th.num, td.num { text-align:right; }
		tbody tr:hover { background:linear-gradient(90deg, #ffffff, #fbfeff); }
		.flash { padding:8px 12px; margin:8px 0; border-radius:8px; font-size:.85rem; }
		.flash.info { background:#eef6ff; color:#0f172a; }
		.flash.error { background:#fff2f2; color:#7f1d1d; }
		.summary-files { margin-top:12px; }
		.count { font-size:.85rem; margin:6px 0 12px; color:var(--muted); }
		.scroll-x { overflow-x:auto; border-radius:8px; }
		a { color:var(--accent); }
		/* dynamic filter cards */
		.filter-cards { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
		.card { background:var(--card); border:1px solid var(--border); padding:8px; min-width:140px; position:relative; border-radius:8px; box-shadow:0 2px 6px rgba(2,6,23,0.04); }
		.card .close { position:absolute; right:6px; top:6px; cursor:pointer; color:#9ca3af; font-weight:700; }
		/* compact header controls */
		.header-row > .header-col { margin-right:0; }
		/* responsive tweaks */
		@media (max-width:900px){
			header.page-header { padding:10px; }
			.header-row { flex-direction:column; gap:8px; }
			aside { display:none; }
		}
	</style>
</head>
<body>
	<header class="page-header">
		<form id="global-search-form" method="get" action="/">
			<div class="header-grid">
				<!-- Columns: [search (flex)] [manufacturer] [name] [year] [price] [category] [wd] [seat] [door] -->
				<!-- Row 1: labels -->
				<div style="grid-column:1;" class="header-label">検索</div>
				<div class="header-label" data-col="manufacturer">メーカー</div>
				<div class="header-label" data-col="name">車名</div>
				<div class="header-label" data-col="year">年式</div>
				<div class="header-label" data-col="price">価格</div>
				<div class="header-label" data-col="engine">排気量</div>
				<div class="header-label" data-col="mission1">ミッション種別</div>
				<div class="header-label" data-col="bodytype">ボディ</div>
				<div class="header-label" data-col="category">軽/普通</div>
				<div class="header-label" data-col="wd">駆動</div>
				<div class="header-label" data-col="seat">席数</div>
				<div class="header-label" data-col="door">ドア</div>
				
				<!-- Row 2: controls -->
				<div style="grid-column:1; display:flex; gap:8px; align-items:center;">
					<input id="global-q" name="q" type="text" placeholder="全カラムを検索" value="{{ request.args.get('q','') }}" style="width:256px;" />
					<button type="submit" class="btn-primary" style="margin-right:48px;">検索</button>
				</div>
				<div class="header-control"><div id="ctrl-manufacturer"></div></div>
				<div class="header-control"><div id="ctrl-name"></div></div>
				<div class="header-control"><div id="ctrl-year"></div></div>
				<div class="header-control"><div id="ctrl-price"></div></div>
                
				<div class="header-control"><div id="ctrl-engine">
					<select name="engine" class="hdr-ctrl" style="display:{{ 'inline-block' if request.args.get('engine') else 'none' }};">
						<option value=""></option>
						{% for e in engines %}
							<option value="{{ e }}" {% if request.args.get('engine') == (e|string) %}selected{% endif %}>{{ e }}</option>
						{% endfor %}
					</select>
				</div></div>
				<div class="header-control"><div id="ctrl-mission1">
					<select name="mission1" class="hdr-ctrl" style="display:{{ 'inline-block' if request.args.get('mission1') else 'none' }};">
						<option value=""></option>
						{% for m in mission1s %}
							<option value="{{ m }}" {% if request.args.get('mission1') == m %}selected{% endif %}>{{ m }}</option>
						{% endfor %}
					</select>
				</div></div>
				<div class="header-control"><div id="ctrl-bodytype">
					<select name="bodytype" class="hdr-ctrl" style="display:{{ 'inline-block' if request.args.get('bodytype') else 'none' }};">
						<option value=""></option>
						{% for b in bodytypes %}
							<option value="{{ b }}" {% if request.args.get('bodytype') == b %}selected{% endif %}>{{ b }}</option>
						{% endfor %}
					</select>
				</div></div>
				<div class="header-control"><div id="ctrl-category"></div></div>
				<div class="header-control"><div id="ctrl-wd"></div></div>
				<div class="header-control"><div id="ctrl-seat"></div></div>
				<div class="header-control"><div id="ctrl-door"></div></div>
			</div>
		</form>
	</header>
	<main>
		<section>
			<div style="display:flex; justify-content:space-between; align-items:center;">
				<h1>検索結果</h1>
				<a href="/pivot" class="btn-link btn-secondary" style="margin-left:auto;">pivot</a>
			</div>
			{% with messages = get_flashed_messages(with_categories=true) %}
				{% if messages %}
					{% for cat, msg in messages %}<div class="flash {{ cat }}">{{ msg }}</div>{% endfor %}
				{% endif %}
			{% endwith %}
			<div class="count">{{ rows|length }} 件 (最大300件表示)</div>
			<div class="scroll-x">
				<table>
					<thead>
						<tr>
							<th data-col="url" class="no-sort">リンク</th>
							<th data-col="price" class="sortable num">価格(万)</th>
							<th data-col="year" class="sortable num">年式</th>
							<th data-col="manufacturer" class="sortable">メーカー</th>
							<th data-col="name" class="sortable">車名</th>
							<th data-col="rd" class="sortable num">走行距離</th>
							<th data-col="engine" class="sortable num">排気量</th>
							<th data-col="mission1" class="sortable">ミッション種別</th>
							<th data-col="mission2" class="sortable">ミッション詳細</th>
							<th data-col="bodytype" class="sortable">ボディ</th>
							<th data-col="category" class="sortable">区分</th>
							<th data-col="wd" class="sortable">駆動</th>
							<th data-col="seat" class="sortable">席数</th>
							<th data-col="door" class="sortable">ドア</th>
							<th data-col="fuel" class="sortable">燃料</th>
							<th data-col="handle" class="sortable">ハンドル</th>
							<th data-col="jc08" class="sortable">JC08</th>
							<th data-col="location" class="sortable">所在地</th>
							<th data-col="repair" class="sortable">修復</th>
						</tr>
					</thead>
					<tbody>
					{% for r in rows %}
						<tr{% if loop.index0 % 2 == 1 %} style="background:#e3f0fb;"{% endif %}>
							<td>{% if r.url %}<a href="{{ r.url }}" target="_blank" rel="noopener">open</a>{% endif %}</td>
							<td class="num">{% if r.price is not none %}{{ '{:,}'.format(r.price) }}万{% endif %}</td>
							<td class="num">{% if r.year is not none %}{{ r.year }}年式{% endif %}</td>
							<td>{{ r.manufacturer or '' }}</td>
							<td>{{ r.name or '' }}</td>
							<td class="num">{% if r.rd is not none %}{{ '{:,}'.format(r.rd) }}km{% endif %}</td>
							<td class="num">{% if r.engine is not none %}{{ '{:,}'.format(r.engine) }}cc{% endif %}</td>
							<td>{{ r.mission1 or '' }}</td>
							<td>{{ r.mission2 or '' }}</td>
							<td>{% if r.bodytype and r.bodytype != 'ボディタイプ' %}{{ r.bodytype }}{% endif %}</td>
							<td>{{ r.category or '' }}</td>
							<td>{{ r.wd or '' }}</td>
							<td>{{ r.seat or '' }}</td>
							<td>{{ r.door or '' }}</td>
							<td>{{ r.fuel or '' }}</td>
							<td>{{ r.handle or '' }}</td>
							<td>{{ r.jc08 or '' }}</td>
							<td>{{ r.location or '' }}</td>
							<td>{{ r.repair or '' }}</td>
						</tr>
					{% endfor %}
					{% if rows|length == 0 %}
						<tr><td colspan="10" style="text-align:center;color:#777;">該当なし</td></tr>
					{% endif %}
					</tbody>
				</table>
			</div>
			<script>
			(function(){
			  const params = new URLSearchParams(window.location.search);
			  const currentSort = params.get('sort') || '{{ sort }}';
			  const currentDir = params.get('dir') || '{{ dir }}';
			  document.querySelectorAll('th.sortable').forEach(th => {
			    const col = th.getAttribute('data-col');
			    if(col === currentSort){
			      th.style.background = '#dde7f5';
			      const arrow = currentDir === 'asc' ? '▲' : '▼';
			      th.innerHTML = th.textContent + ' ' + arrow;
			    }
			    th.addEventListener('click', () => {
			      let dir = 'asc';
			      if(col === currentSort){ dir = currentDir === 'asc' ? 'desc' : 'asc'; }
			      params.set('sort', col); params.set('dir', dir);
			      window.location.search = params.toString();
			    });
			  });

							// Auto submit header filters: use the header form and bind handlers to controls
							const form = document.getElementById('global-search-form');
							const debounce = (fn, ms) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
							const submit = ()=>{ if(form) form.submit(); };
							const dsubmit = debounce(submit, 350);

			  // header behavior: focus and Enter submits
			  const gq = document.getElementById('global-q');
			  if(gq){ gq.focus(); gq.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); document.getElementById('global-search-form').submit(); } }); }

							  // dynamic header controls: populate ctrl-... placeholders
							const OPTIONS = {
								manufacturer: {{ manufacturers|tojson }},
								name: {{ names|tojson }},
								mission1: {{ mission1s|tojson }},
								mission2: {{ mission2s|tojson }},
								bodytype: {{ bodytypes|tojson }},
								repair: {{ repairs|tojson }},
								location: {{ locations|tojson }},
								year: {{ years|tojson }},
								category: {{ categories|tojson }},
								wd: {{ wds|tojson }},
								seat: {{ seats|tojson }},
								door: {{ doors|tojson }},
								fuel: {{ fuels|tojson }},
								handle: {{ handles|tojson }},
							};
							const INIT = {
								manufacturer: {{ request.args.get('manufacturer','')|tojson }},
								name: {{ request.args.get('name','')|tojson }},
								year_min: {{ request.args.get('year_min','')|tojson }},
								price_max: {{ request.args.get('price_max','')|tojson }},
								category: {{ request.args.get('category','')|tojson }},
								wd: {{ request.args.get('wd','')|tojson }},
								seat: {{ request.args.get('seat','')|tojson }},
								door: {{ request.args.get('door','')|tojson }},
								engine: {{ request.args.get('engine','')|tojson }},
								mission1: {{ request.args.get('mission1','')|tojson }},
								bodytype: {{ request.args.get('bodytype','')|tojson }},
							};

																						function insertControlById(id, node){
																								const wrap = document.getElementById(id);
																								if(!wrap) return;
																								wrap.innerHTML = '';
																								// hide by default; label click will focus and show
																								node.style.display = 'none';
																								wrap.appendChild(node);
																								// attach auto-submit handlers depending on control type
																								try{
																									const tag = (node.tagName||'').toUpperCase();
																									if(tag === 'SELECT'){
																										node.addEventListener('change', submit);
																									} else if(tag === 'INPUT' && node.type === 'number'){
																										node.addEventListener('input', dsubmit);
																									}
																								}catch(e){ /* ignore */ }
																						}

							// manufacturer select
							(function(){
								const sel = document.createElement('select'); sel.name='manufacturer'; sel.classList.add('hdr-ctrl');
								const any = document.createElement('option'); any.value=''; any.textContent=''; sel.appendChild(any);
								(OPTIONS.manufacturer||[]).forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; sel.appendChild(opt); });
								insertControlById('ctrl-manufacturer', sel);
								// initialize from query
								if(INIT.manufacturer){ sel.value = INIT.manufacturer; sel.style.display = 'inline-block'; }
							})();

							// name select
							(function(){
								const sel = document.createElement('select'); sel.name='name'; sel.classList.add('hdr-ctrl');
								const any = document.createElement('option'); any.value=''; any.textContent=''; sel.appendChild(any);
								(OPTIONS.name||[]).forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; sel.appendChild(opt); });
								insertControlById('ctrl-name', sel);
								if(INIT.name){ sel.value = INIT.name; sel.style.display = 'inline-block'; }
							})();

							// year >= input
							(function(){ const inp=document.createElement('input'); inp.type='number'; inp.name='year_min'; inp.placeholder='年'; inp.classList.add('hdr-ctrl'); insertControlById('ctrl-year', inp); if(INIT.year_min){ inp.value = INIT.year_min; inp.style.display='inline-block'; } })();

							// price <= input
							  (function(){ const inp=document.createElement('input'); inp.type='number'; inp.name='price_max'; inp.placeholder='万'; inp.classList.add('hdr-ctrl'); insertControlById('ctrl-price', inp); if(INIT.price_max){ inp.value = INIT.price_max; inp.style.display='inline-block'; } })();

							// category: 軽/普通
							  (function(){ const sel=document.createElement('select'); sel.name='category'; sel.classList.add('hdr-ctrl'); const any=document.createElement('option'); any.value=''; any.textContent=''; sel.appendChild(any); ['軽','普通'].forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; sel.appendChild(opt); }); insertControlById('ctrl-category', sel); if(INIT.category){ sel.value = INIT.category; sel.style.display='inline-block'; } })();

							// wd
							  (function(){ const sel=document.createElement('select'); sel.name='wd'; sel.classList.add('hdr-ctrl'); const any=document.createElement('option'); any.value=''; any.textContent=''; sel.appendChild(any); (OPTIONS.wd||[]).forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; sel.appendChild(opt); }); insertControlById('ctrl-wd', sel); if(INIT.wd){ sel.value = INIT.wd; sel.style.display='inline-block'; } })();


							// seat
							  (function(){ const sel=document.createElement('select'); sel.name='seat'; sel.classList.add('hdr-ctrl'); const any=document.createElement('option'); any.value=''; any.textContent=''; sel.appendChild(any); (OPTIONS.seat||[]).forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; sel.appendChild(opt); }); insertControlById('ctrl-seat', sel); if(INIT.seat){ sel.value = INIT.seat; sel.style.display='inline-block'; } })();

							// door
							  (function(){ const sel=document.createElement('select'); sel.name='door'; sel.classList.add('hdr-ctrl'); const any=document.createElement('option'); any.value=''; any.textContent=''; sel.appendChild(any); (OPTIONS.door||[]).forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; sel.appendChild(opt); }); insertControlById('ctrl-door', sel); if(INIT.door){ sel.value = INIT.door; sel.style.display='inline-block'; } })();



											// clicking labels toggles visibility and focuses the control
											document.querySelectorAll('.header-label').forEach(lbl => {
												lbl.style.cursor = 'pointer';
												lbl.addEventListener('click', ()=>{
													const col = lbl.getAttribute('data-col');
													const el = document.getElementById('ctrl-' + col);
													if(!el) return;
													const child = el.firstElementChild;
													if(!child) return;
													// toggle visibility
													if(child.style.display === 'none' || child.style.display === ''){
														child.style.display = 'inline-block';
														if(typeof child.select === 'function') child.select();
														if(typeof child.focus === 'function') child.focus();
													} else {
														child.style.display = 'none';
													}
												});
											});
											// ensure server-rendered hdr-ctrl elements also have auto-submit handlers
											document.addEventListener('DOMContentLoaded', ()=>{
												document.querySelectorAll('.hdr-ctrl').forEach(el=>{
													if(el.tagName === 'SELECT') el.addEventListener('change', submit);
													if(el.tagName === 'INPUT' && el.type === 'number') el.addEventListener('input', dsubmit);
												});
											});
			})();
			</script>
		</section>
	</main>
</body>
</html>
