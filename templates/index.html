<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8" />
	<title>Goo-net 検索</title>
	<style>
		:root { --sidebar-width: 260px; }
		body { font-family: system-ui, sans-serif; margin:0; display:flex; flex-direction:column; }
		header.page-header { width:100%; border-bottom:1px solid #ddd; padding:12px 20px; box-sizing:border-box; }
		.header-row { display:flex; gap:12px; align-items:flex-start; }
		.header-col { display:flex; flex-direction:column; min-width:120px; }
		.header-col label { font-size:.9rem; color:#333; }
		.header-col .control { margin-top:6px; }
		main { display:flex; flex:1; }
		aside { width:var(--sidebar-width); background:#f7f7f9; border-right:1px solid #ddd; padding:16px; box-sizing:border-box; }
		main > section { flex:1; padding:20px; overflow:auto; }
		/* keep existing styles below */
		h1 { margin-top:0; font-size:1.2rem; }
		fieldset { border:1px solid #ccc; margin:0 0 12px; padding:8px 10px; }
		fieldset legend { font-size:.85rem; padding:0 4px; }
		label { display:block; font-size:.8rem; margin:4px 0 2px; }
		select, input[type=text], input[type=number] { width:100%; box-sizing:border-box; padding:4px; }
		.actions { display:flex; gap:6px; margin-top:8px; }
		button, .btn-link { cursor:pointer; font-size:.8rem; padding:6px 10px; }
		.btn-primary { background:#2b6cb0; color:#fff; border:1px solid #1d4f7d; }
		.btn-secondary { background:#eee; border:1px solid #bbb; }
		table { border-collapse:collapse; width:100%; font-size:.75rem; }
		th, td { border:1px solid #ccc; padding:3px 6px; text-align:left; vertical-align:top; }
		th { background:#fafafa; position:sticky; top:0; z-index:2; }
		th.num, td.num { text-align:right; }
		.flash { padding:6px 10px; margin:4px 0; border-radius:4px; font-size:.75rem; }
		.flash.info { background:#eef; }
		.flash.error { background:#fdd; }
		.summary-files { margin-top:20px; }
		.count { font-size:.8rem; margin:4px 0 10px; color:#555; }
		.scroll-x { overflow-x:auto; }
		a { color:#1d4f7d; }
		/* dynamic filter cards */
		.filter-cards { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
		.card { background:#fff; border:1px solid #ddd; padding:8px; width:200px; position:relative; box-shadow:0 1px 3px rgba(0,0,0,0.03); }
		.card .close { position:absolute; right:6px; top:4px; cursor:pointer; color:#999; }
	</style>
</head>
<body>
	<header class="page-header">
		<form id="global-search-form" method="get" action="/">
			<div class="header-row">
				<div class="header-col" style="flex:1;">
					<label>検索</label>
					<div class="control">
						<input id="global-q" name="q" type="text" placeholder="全カラムを検索" value="{{ request.args.get('q','') }}" />
					</div>
				</div>
				<div class="header-col" style="width:100px;">
					<label style="visibility:hidden">検索ボタン</label>
					<div class="control">
						<button type="submit" class="btn-primary">検索</button>
					</div>
				</div>
				<div class="header-col" style="width:40px;">
					<label style="visibility:hidden">追加</label>
					<div class="control">
						<button id="add-filter" type="button" class="btn-secondary">+</button>
					</div>
				</div>
			</div>
			<div class="filter-cards" id="filter-cards">
				<!-- dynamic filter cards will be inserted here -->
			</div>
		</form>
	</header>
	<main>
		<aside>
			<h1>検索条件</h1>
			<!-- Keep the old quick filters, but these will now serve as presets for adding cards -->
			<fieldset>
				<legend>プリセット(クリックでカード追加)</legend>
				<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
					<button type="button" class="btn-secondary" data-col="manufacturer">メーカー</button>
					<button type="button" class="btn-secondary" data-col="name">車名</button>
					<button type="button" class="btn-secondary" data-col="year">年式</button>
					<button type="button" class="btn-secondary" data-col="price">価格</button>
					<button type="button" class="btn-secondary" data-col="category">区分</button>
					<button type="button" class="btn-secondary" data-col="wd">駆動</button>
					<button type="button" class="btn-secondary" data-col="seat">席数</button>
					<button type="button" class="btn-secondary" data-col="door">ドア</button>
				</div>
			</fieldset>
			<div class="summary-files">
				<h2 style="font-size:1rem;">Summary Files</h2>
				{% if files %}
					<ul style="padding-left:16px; margin:4px 0; max-height:180px; overflow:auto;">
					{% for f in files %}
						<li style="font-size:.7rem;">
							<a href="{{ url_for('main.show_file', name=f) }}">{{ f }}</a>
						</li>
					{% endfor %}
					</ul>
				{% else %}<p style="font-size:.7rem;">なし</p>{% endif %}
			</div>
		</aside>
		<section>
			<div style="display:flex; justify-content:space-between; align-items:center;">
				<h1>検索結果</h1>
				<a href="/pivot" class="btn-link btn-secondary" style="margin-left:auto;">pivot</a>
			</div>
			{% with messages = get_flashed_messages(with_categories=true) %}
				{% if messages %}
					{% for cat, msg in messages %}<div class="flash {{ cat }}">{{ msg }}</div>{% endfor %}
				{% endif %}
			{% endwith %}
			<div class="count">{{ rows|length }} 件 (最大300件表示)</div>
			<div class="scroll-x">
				<table>
					<thead>
						<tr>
							<th data-col="url" class="no-sort">リンク</th>
							<th data-col="price" class="sortable num">価格(万)</th>
							<th data-col="year" class="sortable num">年式</th>
							<th data-col="manufacturer" class="sortable">メーカー</th>
							<th data-col="name" class="sortable">車名</th>
							<th data-col="rd" class="sortable num">走行距離</th>
							<th data-col="engine" class="sortable num">排気量</th>
							<th data-col="mission1" class="sortable">ミッション種別</th>
							<th data-col="mission2" class="sortable">ミッション詳細</th>
							<th data-col="bodytype" class="sortable">ボディ</th>
							<th data-col="category" class="sortable">区分</th>
							<th data-col="wd" class="sortable">駆動</th>
							<th data-col="seat" class="sortable">席数</th>
							<th data-col="door" class="sortable">ドア</th>
							<th data-col="fuel" class="sortable">燃料</th>
							<th data-col="handle" class="sortable">ハンドル</th>
							<th data-col="jc08" class="sortable">JC08</th>
							<th data-col="location" class="sortable">所在地</th>
							<th data-col="repair" class="sortable">修復</th>
						</tr>
					</thead>
					<tbody>
					{% for r in rows %}
						<tr{% if loop.index0 % 2 == 1 %} style="background:#e3f0fb;"{% endif %}>
							<td>{% if r.url %}<a href="{{ r.url }}" target="_blank" rel="noopener">open</a>{% endif %}</td>
							<td class="num">{% if r.price is not none %}{{ '{:,}'.format(r.price) }}万{% endif %}</td>
							<td class="num">{% if r.year is not none %}{{ r.year }}年式{% endif %}</td>
							<td>{{ r.manufacturer or '' }}</td>
							<td>{{ r.name or '' }}</td>
							<td class="num">{% if r.rd is not none %}{{ '{:,}'.format(r.rd) }}km{% endif %}</td>
							<td class="num">{% if r.engine is not none %}{{ '{:,}'.format(r.engine) }}cc{% endif %}</td>
							<td>{{ r.mission1 or '' }}</td>
							<td>{{ r.mission2 or '' }}</td>
							<td>{% if r.bodytype and r.bodytype != 'ボディタイプ' %}{{ r.bodytype }}{% endif %}</td>
							<td>{{ r.category or '' }}</td>
							<td>{{ r.wd or '' }}</td>
							<td>{{ r.seat or '' }}</td>
							<td>{{ r.door or '' }}</td>
							<td>{{ r.fuel or '' }}</td>
							<td>{{ r.handle or '' }}</td>
							<td>{{ r.jc08 or '' }}</td>
							<td>{{ r.location or '' }}</td>
							<td>{{ r.repair or '' }}</td>
						</tr>
					{% endfor %}
					{% if rows|length == 0 %}
						<tr><td colspan="10" style="text-align:center;color:#777;">該当なし</td></tr>
					{% endif %}
					</tbody>
				</table>
			</div>
			<script>
			(function(){
			  const params = new URLSearchParams(window.location.search);
			  const currentSort = params.get('sort') || '{{ sort }}';
			  const currentDir = params.get('dir') || '{{ dir }}';
			  document.querySelectorAll('th.sortable').forEach(th => {
			    const col = th.getAttribute('data-col');
			    if(col === currentSort){
			      th.style.background = '#dde7f5';
			      const arrow = currentDir === 'asc' ? '▲' : '▼';
			      th.innerHTML = th.textContent + ' ' + arrow;
			    }
			    th.addEventListener('click', () => {
			      let dir = 'asc';
			      if(col === currentSort){ dir = currentDir === 'asc' ? 'desc' : 'asc'; }
			      params.set('sort', col); params.set('dir', dir);
			      window.location.search = params.toString();
			    });
			  });

			  // Auto submit filters
			  const form = document.querySelector('aside form[action="/"]');
			  if(form){
			    const debounce = (fn, ms) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
			    const submit = ()=>{ form.submit(); };
			    const dsubmit = debounce(submit, 350);
			    form.querySelectorAll('select').forEach(el => { el.addEventListener('change', submit); });
				form.querySelectorAll('input[type=number]').forEach(el => { el.addEventListener('input', dsubmit); });
			  }

			  // header behavior: focus and Enter submits
			  const gq = document.getElementById('global-q');
			  if(gq){ gq.focus(); gq.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); document.getElementById('global-search-form').submit(); } }); }

			  // dynamic filter cards
			  const cardArea = document.getElementById('filter-cards');
			  const addBtn = document.getElementById('add-filter');
			  const presets = document.querySelectorAll('button[data-col]');
			  function makeCard(col, value){
			    const card = document.createElement('div'); card.className='card';
			    const close = document.createElement('span'); close.className='close'; close.textContent='×'; close.onclick = ()=>card.remove();
			    const label = document.createElement('div'); label.textContent = col; label.style.fontSize='.85rem';
			    const input = document.createElement('input'); input.name = col; input.className='control'; input.value = value || '';
			    card.appendChild(close); card.appendChild(label); card.appendChild(input);
			    return card;
			  }
			  addBtn.addEventListener('click', ()=>{
			    // show a simple select to pick column
			    const sel = document.createElement('select');
			    ['manufacturer','name','year','price','category','wd','seat','door','fuel','handle'].forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
			    const ok = document.createElement('button'); ok.textContent='OK'; ok.type='button';
			    const wrapper = document.createElement('div'); wrapper.className='card'; wrapper.appendChild(sel); wrapper.appendChild(ok);
			    cardArea.appendChild(wrapper);
			    ok.addEventListener('click', ()=>{ const col = sel.value; wrapper.remove(); cardArea.appendChild(makeCard(col)); });
			  });
			  presets.forEach(b=> b.addEventListener('click', ()=>{ cardArea.appendChild(makeCard(b.getAttribute('data-col'))); }));
			})();
			</script>
		</section>
	</main>
</body>
</html>
